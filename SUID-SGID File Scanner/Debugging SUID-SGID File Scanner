#!/usr/bin/env bash

set -Eeuo pipefail
set -x  


trap 'echo "[ERROR] Script failed at line $LINENO" >&2' ERR

REPORT_DIR="/var/log/security-audit"
TIMESTAMP="$(date +%F--%H:%M:%S)"
REPORT_FILE="$REPORT_DIR/suid_sgid_debug_${TIMESTAMP}.log"

EXCLUDES=(
  "tmp"
  "/proc"
  "/sys"
  "/dev"
  "/run"
  "/snap"
  "/var/lib/docker"
)

echo "[INFO] Starting SUID/SGID debug audit"
echo "[INFO] Report directory: $REPORT_DIR"
echo "[INFO] Report file: $REPORT_FILE"

if [ "$(id -u)" -ne 0 ]; then
  echo "[ERROR] Script must be run as root" >&2
  exit 1
fi
echo "[OK] Running as root"

if [ ! -d "$REPORT_DIR" ]; then
  echo "[DEBUG] Report directory does not exist, creating..."
  mkdir -p "$REPORT_DIR"
else
  echo "[DEBUG] Report directory already exists"
fi

# Validate directory permissions
if [ ! -w "$REPORT_DIR" ]; then
  echo "[ERROR] Report directory is not writable: $REPORT_DIR" >&2
  exit 1
fi
echo "[OK] Report directory is writable"

{
  echo "SUID / SGID DEBUG Audit Report"
  echo "Hostname: $(hostname)"
  echo "Date: $(date)"
  echo "======================================"
} > "$REPORT_FILE"

if [ ! -f "$REPORT_FILE" ]; then
  echo "[ERROR] Failed to create report file" >&2
  exit 1
fi
echo "[OK] Report file created"

EXCLUDE_ARGS=()
for path in "${EXCLUDES[@]}"; do
  EXCLUDE_ARGS+=( -path "$path" -prune -o )
done
echo "[DEBUG] Exclude paths configured: ${EXCLUDES[*]}"

echo "[INFO] Scanning for SUID files..."
find / "${EXCLUDE_ARGS[@]}" -type f -perm -4000 -print 2>>"$REPORT_FILE" \
  | tee -a "$REPORT_FILE"

echo "[OK] SUID scan completed"

echo "[INFO] Scanning for SGID files..."
find / "${EXCLUDE_ARGS[@]}" -type f -perm -2000 -print 2>>"$REPORT_FILE" \
  | tee -a "$REPORT_FILE"

echo "[OK] SGID scan completed"

echo "[INFO] Collecting detailed permissions and ownership"

find / "${EXCLUDE_ARGS[@]}" -type f \( -perm -4000 -o -perm -2000 \) \
  -exec ls -l {} \; 2>>"$REPORT_FILE" >>"$REPORT_FILE"

echo "[OK] Detailed metadata collected"

if [ ! -s "$REPORT_FILE" ]; then
  echo "[ERROR] Report file is empty" >&2
  exit 1
fi

echo "[SUCCESS] Debug audit completed successfully"
echo "[SUCCESS] Report saved to $REPORT_FILE"
